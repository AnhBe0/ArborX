pipeline {
    agent {
        label 'DoNotRunAnythingOnMaster'
    }
    stages {
        stage('Build') {
            agent {
                dockerfile {
                    filename "Dockerfile"
                    dir "docker"
                    additionalBuildArgs '--build-arg BASE=nvidia/cuda:10.1-devel --build-arg KOKKOS_OPTIONS="--with-serial --with-openmp --with-cuda --with-cuda-options=enable_lambda --arch=SNB,Volta70"'
                    label 'NVIDIA_Tesla_V100-PCIE-32GB && nvidia-docker'
                }
            }
            steps {
                sh 'rm -rf build && mkdir -p build && cd build && cmake -D CMAKE_BUILD_TYPE=Debug -D CMAKE_CXX_COMPILER=$KOKKOS_DIR/bin/nvcc_wrapper -D CMAKE_PREFIX_PATH="$KOKKOS_DIR;$BOOST_DIR;$BENCHMARK_DIR" -D MPIEXEC_PREFLAGS="--allow-run-as-root" .. && make -j8 VERBOSE=1 && ctest --output-on-failure'
            }
        }
        stage("Style") {
            agent {
                docker {
                    image "dalg24/arborx_base:19.04.0-cuda-9.2"
                    label 'docker'
                }
            }
            environment {
                CLANG_FORMAT_EXE = 'clang-format'
            }
            steps {
                sh './scripts/check_format_cpp.sh'
            }
        }
    }
}
